<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Candidate Dashboard</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="candidate-dashboard.css">
  <!-- Chart JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <!-- 1ï¸âƒ£ Navigation Bar -->
  <nav class="navbar">
    <div class="brand">
      <div class="brand-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18h18" />
          <path d="M18 17V9" />
          <path d="M13 17V5" />
          <path d="M8 17v-3" />
        </svg>
      </div>
      <span>Candidate Dashboard</span>
    </div>

    <div class="nav-links">
      <a href="dashboard.html" class="nav-btn active">Dashboard</a>
      <a href="tests.html" class="nav-btn">Tests</a>

      <!-- Profile Dropdown -->
      <div class="profile-container">
        <!-- Theme Toggle -->
        <div class="profile-trigger" id="theme-toggle-btn" aria-label="Toggle Dark Mode" style="margin-right: 0;">
          <span>ðŸŒ™</span>
        </div>

        <div class="profile-trigger">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="profile-dropdown">
          <div class="dropdown-item profile-link">Profile</div>
          <div class="dropdown-item logout-btn">Logout</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- 2ï¸âƒ£ Main Layout -->
  <main class="main-container">

    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-label">Total Tests Attempted</div>
        <div class="stat-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
          </svg>
        </div>
        <div class="stat-value" id="stat-attempted">0</div>
      </div>

      <div class="stat-card blue">
        <div class="stat-label">Enquiry Pending</div>
        <div class="stat-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M9.09 9a3 3 0 0 1 5.83 1" />
          </svg>
        </div>
        <div class="stat-value" id="stat-pending">0</div>
      </div>

      <div class="stat-card green">
        <div class="stat-label">Selected</div>
        <div class="stat-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
            <polyline points="22 4 12 14.01 9 11.01" />
          </svg>
        </div>
        <div class="stat-value" id="stat-selected">0</div>
      </div>

      <div class="stat-card red">
        <div class="stat-label">Rejected</div>
        <div class="stat-icon">
          <div
            style="font-weight:bold; font-size:1.2rem; border:2px solid white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
            !</div>
        </div>
        <div class="stat-value" id="stat-rejected">0</div>
      </div>
    </div>

    <h2 style="margin-bottom: 1.5rem; font-size:1.5rem;">Welcome Back, Candidate!</h2>

    <div class="dashboard-grid">
      <div class="ongoing-section">
        <h3 class="section-title">Ongoing Assessment</h3>
        <div class="ongoing-card">
          <div class="ongoing-header">
            <div class="ongoing-title">Loading...</div>
            <div class="ongoing-status">In Progress</div>
          </div>
        </div>
      </div>

      <div class="recent-section">
        <h3 class="section-title">Recent Results</h3>
        <div class="results-list">
          <div style="color:var(--text-muted); text-align:center; padding:2rem;">Loading results...</div>
        </div>
      </div>
    </div>

    <!-- Test Outcome Distribution Chart -->
    <h3 class="section-title">Test Outcome Distribution</h3>
    <div class="chart-section">
      <canvas id="skillsChart" height="100"></canvas>
    </div>

  </main>

  <script src="mock-data.js"></script>
  <script src="candidate.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const stateMan = window.candidateState;

      // ðŸš€ N8N INTEGRATION: FETCH DATA
      await stateMan.fetchDashboardData();

      const stats = stateMan.getStats();
      const legacyStats = stateMan.state.stats;

      // 1. Update Stats
      document.getElementById('stat-attempted').innerText = stats.attemptedTests || 0;
      document.getElementById('stat-pending').innerText = legacyStats.pending || 0;
      document.getElementById('stat-selected').innerText = legacyStats.selected || 0;
      document.getElementById('stat-rejected').innerText = legacyStats.rejected || 0;

      // 2. Render Ongoing Assessment
      const ongoingContainer = document.querySelector('.ongoing-section');
      ongoingContainer.innerHTML = `
          <div class="ongoing-card" style="display:flex; align-items:center; justify-content:center; height:150px; color:var(--text-muted); flex-direction:column; gap:10px;">
              <div style="opacity:0.5;">No ongoing assessments.</div>
              <button class="btn-resume" style="width:auto; padding:0.5rem 1rem;" onclick="window.location.href='tests.html'">Take New Test</button>
          </div>
      `;

      // 3. Render Recent Results
      const resultsContainer = document.querySelector('.results-list');
      if (stats.testHistory && stats.testHistory.length > 0) {
        resultsContainer.innerHTML = '';
        stats.testHistory.slice(-3).reverse().forEach((attempt, i) => {
          const status = attempt.quizCorrect ? "Passed Quiz" : "Failed Quiz";
          const color = attempt.quizCorrect ? "green" : "red";
          resultsContainer.innerHTML += `
               <div class="result-card">
                 <div class="result-info">
                   <h4>Assessment Attempt #${stats.testHistory.length - i}</h4>
                   <div class="result-meta">
                     <span class="result-status status-passed">Completed</span> - Codesize: ${attempt.codingLength || 0} chars
                   </div>
                 </div>
                 <button class="btn-view ${color}" disabled>${status}</button>
               </div>
             `;
        });
      } else {
        resultsContainer.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:2rem;">No results yet.</div>';
      }

      // ðŸ“Š Chart Logic
      let candidateChart = null;
      function renderCandidateChart() {
        const chartCanvas = document.getElementById('skillsChart');
        if (!chartCanvas) return;
        const ctx = chartCanvas.getContext('2d');
        if (candidateChart) candidateChart.destroy();

        const attempted = parseInt(document.getElementById('stat-attempted').innerText) || 0;
        const pending = parseInt(document.getElementById('stat-pending').innerText) || 0;
        const selected = parseInt(document.getElementById('stat-selected').innerText) || 0;
        const rejected = parseInt(document.getElementById('stat-rejected').innerText) || 0;

        const maxDataValue = Math.max(attempted, pending, selected, rejected);
        let niceMax = 10;
        let stepSize = 1;

        if (maxDataValue > 0) {
          stepSize = Math.max(1, Math.ceil(maxDataValue / 5));
          niceMax = Math.ceil((maxDataValue * 1.1) / stepSize) * stepSize;
        }

        const chartColors = { attempted: '#3B82F6', pending: '#EAB308', selected: '#22C55E', rejected: '#EF4444' };
        const isLight = document.body.classList.contains('light-mode');
        const textColor = isLight ? '#1F2937' : '#F9FAFB';
        const borderColor = isLight ? '#1F2937' : '#475569';
        const gridColor = isLight ? 'rgba(31, 41, 55, 0.08)' : 'rgba(249, 250, 251, 0.1)';

        candidateChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Attempted', 'Pending', 'Selected', 'Rejected'],
            datasets: [{
              label: 'Candidates',
              data: [attempted, pending, selected, rejected],
              backgroundColor: [chartColors.attempted, chartColors.pending, chartColors.selected, chartColors.rejected],
              borderRadius: 6,
              barPercentage: 0.6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: textColor }, grid: { display: false } },
              y: { beginAtZero: true, max: niceMax, ticks: { color: textColor, stepSize: stepSize }, grid: { color: gridColor } }
            }
          }
        });
      }

      const chartSection = document.querySelector('.chart-section');
      if (chartSection) {
        chartSection.innerHTML = `
          <div class="chart-legend-container">
              <div>
                  <div class="chart-title">TEST STATUS OVERVIEW</div>
                  <div class="chart-subtitle">Real-time distribution of your outcomes</div>
              </div>
              <div id="customLegend"></div>
          </div>
          <div class="chart-wrapper"><canvas id="skillsChart"></canvas></div>
        `;
      }

      renderCandidateChart();
      window.addEventListener('themeChanged', renderCandidateChart);

      const observer = new MutationObserver(renderCandidateChart);
      ['stat-attempted', 'stat-pending', 'stat-selected', 'stat-rejected'].forEach(id => {
        const el = document.getElementById(id);
        if (el) observer.observe(el, { childList: true, characterData: true, subtree: true });
      });
    });
  </script>
</body>

</html>